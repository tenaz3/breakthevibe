{% extends "base.html" %}
{% block title %}Test Result â€” BreakTheVibe{% endblock %}
{% block content %}

<!-- Back link -->
<a href="javascript:history.back()"
   class="inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors mb-5">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
    </svg>
    Back to Project
</a>

<!-- Header -->
<div class="flex items-center gap-3 mb-6">
    <h1 class="text-2xl font-bold text-foreground">Test Run: {{ run_id[:8] if run_id else 'N/A' }}</h1>
    <span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold uppercase
        {% if status == 'passed' %}bg-emerald-900/50 text-emerald-300
        {% elif status == 'failed' %}bg-red-900/50 text-red-300
        {% elif status == 'running' %}bg-blue-900/50 text-blue-300
        {% else %}bg-muted text-muted-foreground{% endif %}">
        {{ status }}
    </span>
</div>

<!-- Error banner (shown when pipeline fails with an error) -->
{% if result and result.error_message %}
<div class="bg-red-900/30 border border-red-700/50 rounded-lg p-4 mb-6">
    <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-400 mt-0.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
        </svg>
        <div>
            <h3 class="text-sm font-semibold text-red-300">
                Pipeline failed{% if result.failed_stage %} at stage: <span class="font-mono">{{ result.failed_stage }}</span>{% endif %}
            </h3>
            <p class="text-sm text-red-300/80 mt-1">{{ result.error_message }}</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Stats bar -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
    <div class="bg-card border border-border rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-foreground">{{ total }}</div>
        <div class="text-xs text-muted-foreground mt-1">Total</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-success">{{ passed }}</div>
        <div class="text-xs text-muted-foreground mt-1">Passed</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-destructive">{{ failed }}</div>
        <div class="text-xs text-muted-foreground mt-1">Failed</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-foreground">{{ duration }}</div>
        <div class="text-xs text-muted-foreground mt-1">Duration</div>
    </div>
</div>

<!-- Healed selectors warning -->
{% if heal_warnings %}
<div class="bg-card border border-warning/50 rounded-lg p-5 mb-6">
    <h3 class="text-sm font-semibold text-warning mb-3">Healed Selectors</h3>
    <ul class="space-y-1.5">
        {% for warning in heal_warnings %}
        <li class="text-sm text-muted-foreground">{{ warning }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Test suites -->
{% if suites %}
<div class="space-y-2 mb-6">
    {% for suite in suites %}
    <details class="bg-card border border-border rounded-lg">
        <summary class="cursor-pointer flex items-center justify-between px-5 py-3">
            <strong class="text-sm font-semibold text-foreground">{{ suite.name }}</strong>
            <span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold uppercase
                {% if suite.success %}bg-emerald-900/50 text-emerald-300{% else %}bg-red-900/50 text-red-300{% endif %}">
                {{ 'PASS' if suite.success else 'FAIL' }}
            </span>
        </summary>
        <pre class="px-5 pb-4 pt-2 text-xs font-mono overflow-x-auto text-muted-foreground whitespace-pre-wrap">{{ suite.stdout }}</pre>
    </details>
    {% endfor %}
</div>
{% elif not (result and result.error_message) %}
<!-- Empty state: no suites AND no error -->
<div class="bg-card border border-border rounded-lg p-8 mb-6 text-center">
    <svg class="w-10 h-10 text-muted-foreground mx-auto mb-3" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
    </svg>
    <p class="text-sm text-muted-foreground">No test data available</p>
</div>
{% endif %}

<!-- Step Replay panel -->
<div class="bg-card border border-border rounded-lg p-5 mb-6" id="replay-panel">
    <h3 class="text-sm font-semibold text-foreground mb-3">Step Replay</h3>
    <div class="flex items-center gap-3 mb-3">
        <button class="inline-flex items-center px-3 py-1.5 rounded-md bg-secondary text-secondary-foreground text-xs font-medium border border-border hover:bg-accent transition-colors" id="replay-prev">Previous</button>
        <span id="replay-counter" class="text-xs text-muted-foreground">0 / 0</span>
        <button class="inline-flex items-center px-3 py-1.5 rounded-md bg-secondary text-secondary-foreground text-xs font-medium border border-border hover:bg-accent transition-colors" id="replay-next">Next</button>
    </div>
    <div id="replay-step-info" class="text-sm text-foreground"></div>
    <img id="replay-screenshot" class="w-full rounded-md mt-3 hidden" src="" alt="Step screenshot">
    <div id="replay-network" class="mt-2 text-xs text-muted-foreground"></div>
    <pre id="replay-console" class="mt-2 text-xs font-mono text-muted-foreground hidden whitespace-pre-wrap"></pre>
</div>

<!-- Visual diffs -->
{% if diffs %}
<h3 class="text-lg font-semibold text-foreground mt-6 mb-3">Visual Diffs</h3>
{% for diff in diffs %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div>
        <p class="text-xs text-muted-foreground mb-1.5">Baseline</p>
        <img src="{{ diff.baseline }}" alt="Baseline" class="w-full rounded-md border border-border">
    </div>
    <div>
        <p class="text-xs text-muted-foreground mb-1.5">Current</p>
        <img src="{{ diff.current }}" alt="Current" class="w-full rounded-md border border-border">
    </div>
    <div>
        <p class="text-xs text-muted-foreground mb-1.5">Diff</p>
        <img src="{{ diff.diff }}" alt="Diff" class="w-full rounded-md border border-border">
    </div>
</div>
{% endfor %}
{% endif %}

<!-- Video recording -->
{% if video_url %}
<h3 class="text-lg font-semibold text-foreground mt-6 mb-3">Recording</h3>
<video controls class="w-full rounded-lg border border-border">
    <source src="{{ video_url }}" type="video/webm">
</video>
{% endif %}

{% endblock %}
{% block scripts %}
<script src="/static/js/replay.js"></script>
<script>
    window.__replaySteps = {{ replay_steps_json|safe }};
    if (typeof window.loadReplaySteps === 'function') {
        window.loadReplaySteps(window.__replaySteps);
    }
</script>
{% endblock %}
