{% extends "base.html" %}
{% block title %}{{ project.name }} — BreakTheVibe{% endblock %}
{% block content %}
<!-- Back link -->
<a href="/" class="back-link">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    Projects
</a>

<!-- Page header -->
<div class="page-header">
    <h1>{{ project.name }}</h1>
    <span class="badge
        {% if project.status == 'ready' %}badge-success
        {% elif project.status == 'crawling' or project.status == 'running' %}badge-warning
        {% elif project.status == 'failed' %}badge-destructive
        {% else %}badge-secondary{% endif %}">
        {{ project.status }}
    </span>
</div>
<p class="page-description">{{ project.url }}</p>

<!-- Action bar -->
<div class="page-actions mb-8">
    <div id="action-buttons" class="flex flex-wrap items-center gap-2">
        <button class="btn btn-primary" id="btn-crawl"
                hx-post="/api/projects/{{ project.id }}/crawl"
                hx-swap="none"
                hx-disabled-elt="this"
                hx-on::after-request="onPipelineTrigger(event, 'Crawl started')">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg>
            Crawl
        </button>
        <button class="btn btn-primary" id="btn-generate"
                hx-post="/api/projects/{{ project.id }}/generate"
                hx-swap="none"
                hx-disabled-elt="this"
                hx-on::after-request="onPipelineTrigger(event, 'Test generation started')">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
            Generate
        </button>
        <button class="btn btn-primary" id="btn-run"
                hx-post="/api/projects/{{ project.id }}/run"
                hx-swap="none"
                hx-disabled-elt="this"
                hx-on::after-request="onPipelineTrigger(event, 'Test run started')">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"/></svg>
            Run Tests
        </button>

        <div class="separator-vertical"></div>

        <a href="/projects/{{ project.id }}/suites" class="btn btn-secondary">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            Suites
        </a>
        <a href="/projects/{{ project.id }}/sitemap" class="btn btn-secondary">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
            Mind-Map
        </a>
        <a href="/projects/{{ project.id }}/rules" class="btn btn-secondary">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
            Rules
        </a>
    </div>

    <!-- Progress card (hidden until pipeline starts) -->
    <div id="pipeline-progress" class="pipeline-progress-card hidden">
        <div class="flex items-center gap-3 mb-3">
            <svg class="w-4 h-4 animate-spin text-primary" id="progress-spinner" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
            </svg>
            <span class="text-[0.8125rem] font-medium text-foreground" id="progress-label">Pipeline running...</span>
        </div>
        <div class="stage-steps" id="stage-steps"></div>
    </div>
</div>

<!-- Tabs -->
<div class="tab-list mb-6" role="tablist">
    <button role="tab" aria-selected="true" data-tab="runs" class="tab-trigger active">
        Test Runs
    </button>
    <button role="tab" aria-selected="false" data-tab="sitemap" class="tab-trigger">
        Site Map
    </button>
</div>

<!-- Tab: Test Runs -->
<div id="tab-runs" class="tab-panel" role="tabpanel">
    <div class="flex items-center justify-center py-16">
        <div class="flex items-center gap-2 text-muted-foreground text-[0.8125rem]">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
            Loading...
        </div>
    </div>
</div>

<!-- Tab: Site Map -->
<div id="tab-sitemap" class="tab-panel hidden" role="tabpanel">
    <div class="flex items-center justify-center py-16">
        <div class="flex items-center gap-2 text-muted-foreground text-[0.8125rem]">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
            Loading...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var PROJECT_ID = "{{ project.id }}";
    var STAGES = ['crawl', 'map', 'generate', 'run', 'report'];
    var STAGE_LABELS = { crawl: 'Crawl', map: 'Map', generate: 'Generate', run: 'Run Tests', report: 'Report' };
    var _es = null;
    var _esErrCount = 0;

    /* ── Progress card ─────────────────────────────────────────── */
    function renderStageSteps(activeStage, activeStatus) {
        var container = document.getElementById('stage-steps');
        if (!container) return;
        container.textContent = '';
        var activeIdx = STAGES.indexOf(activeStage);

        STAGES.forEach(function(stage, idx) {
            var step = document.createElement('div');
            step.className = 'stage-step';
            var dot = document.createElement('span');
            dot.className = 'stage-dot';
            var label = document.createElement('span');
            label.className = 'stage-label';
            label.textContent = STAGE_LABELS[stage] || stage;

            if (idx < activeIdx || (idx === activeIdx && activeStatus === 'completed')) {
                dot.classList.add('stage-dot-done');
                step.classList.add('stage-step-done');
            } else if (idx === activeIdx && activeStatus === 'failed') {
                dot.classList.add('stage-dot-failed');
                step.classList.add('stage-step-failed');
            } else if (idx === activeIdx && activeStatus === 'started') {
                dot.classList.add('stage-dot-active');
                step.classList.add('stage-step-active');
            } else {
                dot.classList.add('stage-dot-pending');
            }

            step.appendChild(dot);
            step.appendChild(label);
            container.appendChild(step);
        });
    }

    function showProgressCard() {
        document.getElementById('action-buttons').classList.add('hidden');
        var card = document.getElementById('pipeline-progress');
        card.classList.remove('hidden');
        document.getElementById('progress-label').textContent = 'Pipeline running...';
        document.getElementById('progress-spinner').classList.remove('hidden');
    }

    function hideProgressCard() {
        document.getElementById('pipeline-progress').classList.add('hidden');
        document.getElementById('action-buttons').classList.remove('hidden');
    }

    /* ── EventSource lifecycle ──────────────────────────────── */
    function stopStream() {
        if (_es) { _es.close(); _es = null; }
    }

    function startProgressStream() {
        stopStream();
        _esErrCount = 0;
        _es = new EventSource('/api/projects/' + PROJECT_ID + '/progress');

        _es.addEventListener('connected', function(e) {
            _esErrCount = 0;
            var data = JSON.parse(e.data);
            showProgressCard();
            renderStageSteps(data.stage, data.status);
            if (data.status === 'started') {
                document.getElementById('progress-label').textContent =
                    'Running: ' + (STAGE_LABELS[data.stage] || data.stage) + '...';
            }
        });

        _es.addEventListener('stage', function(e) {
            _esErrCount = 0;
            var data = JSON.parse(e.data);
            renderStageSteps(data.stage, data.status);
            if (data.status === 'started') {
                document.getElementById('progress-label').textContent =
                    'Running: ' + (STAGE_LABELS[data.stage] || data.stage) + '...';
            }
        });

        _es.addEventListener('done', function() {
            document.getElementById('progress-label').textContent = 'Pipeline complete!';
            document.getElementById('progress-spinner').classList.add('hidden');
            renderStageSteps('report', 'completed');
            setTimeout(function() {
                hideProgressCard(); stopStream(); loadTestRuns();
                sitemapLoaded = false;
                showToast('Pipeline completed successfully', 'success');
            }, 1200);
        });

        _es.addEventListener('failed', function(e) {
            var data = JSON.parse(e.data);
            document.getElementById('progress-label').textContent =
                'Pipeline failed' + (data.stage ? ' at: ' + (STAGE_LABELS[data.stage] || data.stage) : '');
            document.getElementById('progress-spinner').classList.add('hidden');
            if (data.stage) renderStageSteps(data.stage, 'failed');
            setTimeout(function() {
                hideProgressCard(); stopStream(); loadTestRuns();
                showToast('Pipeline failed: ' + (data.error || 'unknown error'), 'error');
            }, 2000);
        });

        _es.onerror = function() {
            _esErrCount++;
            if ((_es && _es.readyState === EventSource.CLOSED) || _esErrCount >= 3) {
                stopStream();
                hideProgressCard();
                showToast('Lost connection to pipeline stream', 'error');
            }
        };
    }

    window.onPipelineTrigger = function(event, successMsg) {
        if (event.detail.successful) {
            showToast(successMsg, 'success');
            showProgressCard();
            renderStageSteps('crawl', 'started');
            startProgressStream();
        } else {
            showToast('Failed to start pipeline', 'error');
        }
    };

    /* ── Resume progress on page load if pipeline is running ── */
    var projectStatus = "{{ project.status }}";
    if (projectStatus === 'crawling' || projectStatus === 'running') {
        showProgressCard();
        renderStageSteps('crawl', 'started');
        startProgressStream();
    }

    window.addEventListener('pagehide', stopStream);

    /* ── Tab switching ───────────────────────────────────────── */
    var tabBtns = document.querySelectorAll('.tab-trigger');
    var tabPanels = document.querySelectorAll('.tab-panel');

    tabBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            tabBtns.forEach(function(b) {
                b.classList.remove('active');
                b.setAttribute('aria-selected', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');

            tabPanels.forEach(function(p) { p.classList.add('hidden'); });
            var panel = document.getElementById('tab-' + btn.dataset.tab);
            if (panel) panel.classList.remove('hidden');
        });
    });

    /* ── DOM helpers ──────────────────────────────────────────── */
    function el(tag, classes, text) {
        var node = document.createElement(tag);
        if (classes) node.className = classes;
        if (text !== undefined) node.textContent = text;
        return node;
    }

    function svgIcon(pathD, cls) {
        var ns = 'http://www.w3.org/2000/svg';
        var svg = document.createElementNS(ns, 'svg');
        svg.setAttribute('class', cls || 'w-5 h-5');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('viewBox', '0 0 24 24');
        var path = document.createElementNS(ns, 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', pathD);
        svg.appendChild(path);
        return svg;
    }

    function formatDuration(seconds) {
        if (!seconds || seconds < 1) return '< 1s';
        if (seconds < 60) return Math.round(seconds) + 's';
        var m = Math.floor(seconds / 60);
        var s = Math.round(seconds % 60);
        return m + 'm ' + s + 's';
    }

    function clearAndAppend(parentId, children) {
        var parent = document.getElementById(parentId);
        if (!parent) return;
        parent.textContent = '';
        if (!Array.isArray(children)) children = [children];
        children.forEach(function(c) { parent.appendChild(c); });
    }

    /* ── Test Runs ───────────────────────────────────────────── */
    function renderEmptyState(iconPath, heading, subtitle) {
        var wrapper = el('div', 'empty-state');
        wrapper.appendChild(svgIcon(iconPath, 'w-10 h-10 mb-4'));
        wrapper.appendChild(el('p', 'text-[0.875rem] font-medium text-muted-foreground mb-1', heading));
        wrapper.appendChild(el('p', 'text-[0.8125rem] text-muted-foreground/70', subtitle));
        return wrapper;
    }

    function renderTestRuns(data) {
        if (data.status === 'no_runs') {
            clearAndAppend('tab-runs', renderEmptyState(
                'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2',
                'No test runs yet',
                'Run the pipeline to see results here.'
            ));
            return;
        }

        var isSuccess = data.status === 'completed';
        var card = el('div', 'card card-content');

        /* Header */
        var header = el('div', 'flex items-center justify-between mb-4');
        var left = el('div', 'flex items-center gap-3');
        left.appendChild(svgIcon(
            isSuccess
                ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'
                : 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z',
            isSuccess ? 'w-5 h-5 text-success' : 'w-5 h-5 text-destructive'
        ));
        var info = el('div');
        info.appendChild(el('p', 'text-[0.8125rem] font-medium text-foreground', 'Latest Run'));
        if (data.run_id) info.appendChild(el('p', 'text-[0.75rem] text-muted-foreground font-mono', data.run_id));
        left.appendChild(info);
        header.appendChild(left);

        var badge = el('span',
            'badge ' + (isSuccess ? 'badge-success' : 'badge-destructive'),
            data.status
        );
        header.appendChild(badge);
        card.appendChild(header);

        /* Duration */
        if (data.duration_seconds) {
            card.appendChild(el('p', 'text-[0.75rem] text-muted-foreground mb-3', 'Duration: ' + formatDuration(data.duration_seconds)));
        }

        /* Stages */
        var stages = data.completed_stages || [];
        if (stages.length > 0) {
            var row = el('div', 'flex flex-wrap gap-1.5');
            stages.forEach(function(s) {
                row.appendChild(el('span', 'badge badge-success', s));
            });
            card.appendChild(row);
        }

        /* Failed stage */
        if (data.failed_stage) {
            var failRow = el('div', 'mt-3 flex items-center gap-2');
            failRow.appendChild(el('span', 'text-[0.75rem] text-muted-foreground', 'Failed at:'));
            failRow.appendChild(el('span', 'badge badge-destructive', data.failed_stage));
            card.appendChild(failRow);
        }

        /* Error */
        if (data.error_message) {
            var errWrap = el('div', 'callout callout-destructive mt-3');
            errWrap.appendChild(el('p', 'text-[0.75rem] font-mono break-all', data.error_message));
            card.appendChild(errWrap);
        }

        clearAndAppend('tab-runs', card);
    }

    function loadTestRuns() {
        fetch('/api/projects/' + PROJECT_ID + '/results')
            .then(function(res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(renderTestRuns)
            .catch(function(err) {
                var errBox = el('div', 'callout callout-destructive');
                errBox.appendChild(el('p', 'text-[0.8125rem]', 'Failed to load test runs: ' + err.message));
                clearAndAppend('tab-runs', errBox);
            });
    }

    /* ── Site Map ────────────────────────────────────────────── */
    function buildTable(headers, rows, cellRenderer) {
        var wrapper = el('div', 'table-wrapper');
        var table = el('table', 'table');
        var thead = el('thead');
        var headRow = el('tr');
        headers.forEach(function(h) {
            var th = el('th', h.align === 'right' ? 'text-right' : '', h.label);
            headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        var tbody = el('tbody');
        rows.forEach(function(row) {
            var tr = el('tr');
            cellRenderer(tr, row);
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrapper.appendChild(table);
        return wrapper;
    }

    function renderSitemap(data) {
        var pages = data.pages || [];
        var endpoints = data.api_endpoints || [];

        if (pages.length === 0 && endpoints.length === 0) {
            clearAndAppend('tab-sitemap', renderEmptyState(
                'M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7',
                'No sitemap data yet',
                'Crawl the site first to build a sitemap.'
            ));
            return;
        }

        var fragments = [];

        if (pages.length > 0) {
            var section = el('div', 'mb-6');
            var heading = el('h3', 'text-[0.8125rem] font-semibold mb-3');
            heading.textContent = 'Pages ';
            heading.appendChild(el('span', 'text-muted-foreground font-normal', '(' + pages.length + ')'));
            section.appendChild(heading);

            section.appendChild(buildTable(
                [{ label: 'URL' }, { label: 'Title' }, { label: 'Status', align: 'right' }],
                pages,
                function(tr, page) {
                    var url = typeof page === 'string' ? page : (page.url || page.path || '');
                    var title = typeof page === 'object' ? (page.title || '') : '';
                    var status = typeof page === 'object' ? String(page.status_code || page.status || '') : '';
                    tr.appendChild(el('td', 'font-mono text-foreground truncate max-w-xs', String(url)));
                    tr.appendChild(el('td', 'text-muted-foreground', String(title)));
                    tr.appendChild(el('td', 'text-right text-muted-foreground', status));
                }
            ));
            fragments.push(section);
        }

        if (endpoints.length > 0) {
            var epSection = el('div');
            var epHeading = el('h3', 'text-[0.8125rem] font-semibold mb-3');
            epHeading.textContent = 'API Endpoints ';
            epHeading.appendChild(el('span', 'text-muted-foreground font-normal', '(' + endpoints.length + ')'));
            epSection.appendChild(epHeading);

            epSection.appendChild(buildTable(
                [{ label: 'Method' }, { label: 'Path' }],
                endpoints,
                function(tr, ep) {
                    var method = typeof ep === 'string' ? 'GET' : (ep.method || 'GET');
                    var path = typeof ep === 'string' ? ep : (ep.path || ep.url || '');
                    var methodColor = method === 'GET' ? 'text-success'
                        : method === 'POST' ? 'text-ring'
                        : method === 'PUT' ? 'text-warning'
                        : method === 'DELETE' ? 'text-destructive'
                        : 'text-muted-foreground';
                    tr.appendChild(el('td', 'font-mono font-semibold text-[0.75rem] ' + methodColor, String(method)));
                    tr.appendChild(el('td', 'font-mono text-foreground', String(path)));
                }
            ));
            fragments.push(epSection);
        }

        clearAndAppend('tab-sitemap', fragments);
    }

    var sitemapLoaded = false;

    function loadSitemap() {
        if (sitemapLoaded) return;
        sitemapLoaded = true;

        fetch('/api/projects/' + PROJECT_ID + '/sitemap')
            .then(function(res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(renderSitemap)
            .catch(function(err) {
                var errBox = el('div', 'callout callout-destructive');
                errBox.appendChild(el('p', 'text-[0.8125rem]', 'Failed to load sitemap: ' + err.message));
                clearAndAppend('tab-sitemap', errBox);
            });
    }

    /* ── Lazy-load sitemap ───────────────────────────────────── */
    document.querySelector('[data-tab="sitemap"]').addEventListener('click', loadSitemap);

    /* ── Initial load ────────────────────────────────────────── */
    loadTestRuns();
})();
</script>
{% endblock %}
