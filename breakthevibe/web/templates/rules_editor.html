{% extends "base.html" %}
{% block title %}Rules Editor â€” BreakTheVibe{% endblock %}
{% block content %}
<div class="flex items-center gap-4 mb-6">
    <h1 class="text-2xl font-bold">Rules Editor</h1>
    <a href="/projects/{{ project.id }}"
       class="inline-flex items-center px-3 py-1.5 rounded-md bg-secondary text-secondary-foreground text-xs font-medium border border-border hover:bg-accent transition-colors">
        Back to Project
    </a>
</div>

<form hx-put="/api/projects/{{ project.id }}/rules" hx-swap="none"
      hx-on::after-request="if(event.detail.successful){showToast('Rules saved successfully','success')}else{showToast('Failed to save rules')}"
      enctype="application/x-www-form-urlencoded">
    <textarea name="rules_yaml" spellcheck="false"
              class="w-full min-h-[400px] px-4 py-3 bg-background border border-border rounded-lg text-foreground text-sm font-mono placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
    >{{ rules_yaml }}</textarea>
    <div class="flex gap-3 mt-4">
        <button type="submit"
                class="inline-flex items-center px-4 py-2 rounded-lg bg-primary text-primary-foreground text-sm font-medium hover:bg-primary-hover transition-colors">
            Save Rules
        </button>
        <button type="button" id="validate-btn"
                class="inline-flex items-center px-4 py-2 rounded-lg bg-secondary text-secondary-foreground text-sm font-medium border border-border hover:bg-accent transition-colors">
            Validate
        </button>
        <button type="button" id="reset-btn"
                class="inline-flex items-center px-4 py-2 rounded-lg bg-secondary text-secondary-foreground text-sm font-medium border border-border hover:bg-accent transition-colors">
            Reset to Defaults
        </button>
    </div>
</form>

<details class="bg-card border border-border rounded-lg p-5 mt-6" open>
    <summary class="cursor-pointer text-lg font-semibold">Configuration Reference</summary>
    <div class="mt-3 text-sm text-muted-foreground">
        <pre id="default-config" class="whitespace-pre-wrap">crawl:
  max_depth: 5           # Maximum crawl depth
  skip_urls: []          # Glob patterns to skip
  scroll_behavior: auto  # auto | none | full
  viewport: [1280, 720]  # Width, height
  wait_times:
    page_load: 3000      # ms to wait after navigation
    network_idle: 1000   # ms to wait for network idle

inputs:
  email: "test@example.com"
  password: "Test123!"

interactions:
  cookie_banner: dismiss
  modals: close
  infinite_scroll: false

tests:
  skip_visual: ["*/admin/*"]

api:
  ignore_endpoints: ["*/analytics*"]
  expected_overrides:
    "GET /api/users": { status: 200 }

execution:
  mode: smart           # smart | sequential | parallel
  suites:
    api_tests: { workers: 4 }</pre>
    </div>
</details>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('validate-btn')?.addEventListener('click', function() {
    var yaml = document.querySelector('[name=rules_yaml]').value;
    fetch('/api/rules/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({yaml: yaml})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.valid) {
            showToast('Valid YAML configuration', 'success');
        } else {
            showToast('Invalid: ' + data.error, 'error');
        }
    })
    .catch(function() {
        showToast('Validation request failed', 'error');
    });
});
document.getElementById('reset-btn')?.addEventListener('click', function() {
    document.querySelector('[name=rules_yaml]').value =
        document.getElementById('default-config').textContent;
});
</script>
{% endblock %}
