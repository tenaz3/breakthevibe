{% extends "base.html" %}
{% block title %}Rules Editor â€” BreakTheVibe{% endblock %}
{% block content %}
<a href="/projects/{{ project.id }}" class="back-link">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    {{ project.name }}
</a>

<div class="page-header mb-6">
    <h1>Rules Editor</h1>
</div>

<form hx-put="/api/projects/{{ project.id }}/rules" hx-swap="none"
      hx-on::after-request="if(event.detail.successful){showToast('Rules saved','success')}else{showToast('Failed to save rules')}"
      enctype="application/x-www-form-urlencoded">
    <textarea name="rules_yaml" spellcheck="false" class="code-editor">{{ rules_yaml }}</textarea>
    <div class="flex gap-3 mt-4">
        <button type="submit" class="btn btn-primary">Save Rules</button>
        <button type="button" id="validate-btn" class="btn btn-secondary">Validate</button>
        <button type="button" id="reset-btn" class="btn btn-ghost">Reset to Defaults</button>
    </div>
</form>

<hr class="separator">

<details class="accordion" open>
    <summary>Configuration Reference</summary>
    <pre id="default-config" class="accordion-content text-[0.8125rem] font-mono text-muted-foreground whitespace-pre-wrap">crawl:
  max_depth: 5           # Maximum crawl depth
  skip_urls: []          # Glob patterns to skip
  scroll_behavior: auto  # auto | none | full
  viewport: [1280, 720]  # Width, height
  wait_times:
    page_load: 3000      # ms to wait after navigation
    network_idle: 1000   # ms to wait for network idle

inputs:
  email: "test@example.com"
  password: "Test123!"

interactions:
  cookie_banner: dismiss
  modals: close
  infinite_scroll: false

tests:
  skip_visual: ["*/admin/*"]

api:
  ignore_endpoints: ["*/analytics*"]
  expected_overrides:
    "GET /api/users": { status: 200 }

execution:
  mode: smart           # smart | sequential | parallel
  suites:
    api_tests: { workers: 4 }</pre>
</details>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('validate-btn')?.addEventListener('click', function() {
    var yaml = document.querySelector('[name=rules_yaml]').value;
    fetch('/api/rules/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({yaml: yaml})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.valid) {
            showToast('Valid YAML configuration', 'success');
        } else {
            showToast('Invalid: ' + data.error, 'error');
        }
    })
    .catch(function() {
        showToast('Validation request failed', 'error');
    });
});

document.getElementById('reset-btn')?.addEventListener('click', function() {
    document.querySelector('[name=rules_yaml]').value =
        document.getElementById('default-config').textContent;
});
</script>
{% endblock %}
