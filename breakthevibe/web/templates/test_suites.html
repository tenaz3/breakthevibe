{% extends "base.html" %}
{% block title %}Test Suites â€” {{ project.name }}{% endblock %}
{% block content %}
<div class="flex items-center gap-4 mb-6">
    <h1 class="text-2xl font-bold">Test Suites</h1>
    <a href="/projects/{{ project.id }}"
       class="inline-flex items-center px-3 py-1.5 rounded-md bg-secondary text-secondary-foreground text-xs font-medium border border-border hover:bg-accent transition-colors">
        Back to Project
    </a>
</div>

<!-- Filter by category -->
<div class="flex gap-3 flex-wrap mb-6">
    <a href="?category="
       class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium border transition-colors {% if not category %}bg-primary text-primary-foreground border-primary hover:bg-primary-hover{% else %}bg-secondary text-secondary-foreground border-border hover:bg-accent{% endif %}">
        All
    </a>
    <a href="?category=functional"
       class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium border transition-colors {% if category == 'functional' %}bg-primary text-primary-foreground border-primary hover:bg-primary-hover{% else %}bg-secondary text-secondary-foreground border-border hover:bg-accent{% endif %}">
        Functional
    </a>
    <a href="?category=visual"
       class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium border transition-colors {% if category == 'visual' %}bg-primary text-primary-foreground border-primary hover:bg-primary-hover{% else %}bg-secondary text-secondary-foreground border-border hover:bg-accent{% endif %}">
        Visual
    </a>
    <a href="?category=api"
       class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium border transition-colors {% if category == 'api' %}bg-primary text-primary-foreground border-primary hover:bg-primary-hover{% else %}bg-secondary text-secondary-foreground border-border hover:bg-accent{% endif %}">
        API
    </a>
</div>

{% if suites_by_route %}
{% for route, suites in suites_by_route.items() %}
<div class="bg-card border border-border rounded-lg p-5 mb-4">
    <h3 class="text-lg font-semibold mb-3">{{ route }}</h3>
    <table class="w-full">
        <thead>
            <tr class="border-b border-border">
                <th class="text-left text-sm text-muted-foreground font-medium py-2 px-3">Suite</th>
                <th class="text-left text-sm text-muted-foreground font-medium py-2 px-3">Category</th>
                <th class="text-left text-sm text-muted-foreground font-medium py-2 px-3">Steps</th>
                <th class="text-right text-sm text-muted-foreground font-medium py-2 px-3">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for suite in suites %}
            <tr class="border-b border-border">
                <td class="py-2 px-3 text-sm">{{ suite.name }}</td>
                <td class="py-2 px-3">
                    <span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold uppercase
                        {% if suite.category == 'functional' %}bg-blue-900/50 text-blue-300
                        {% elif suite.category == 'visual' %}bg-purple-900/50 text-purple-300
                        {% elif suite.category == 'api' %}bg-emerald-900/50 text-emerald-300
                        {% else %}bg-muted text-muted-foreground{% endif %}">
                        {{ suite.category }}
                    </span>
                </td>
                <td class="py-2 px-3 text-sm text-muted-foreground">{{ suite.step_count }}</td>
                <td class="py-2 px-3 text-right">
                    <button class="inline-flex items-center px-3 py-1.5 rounded-md bg-secondary text-secondary-foreground text-xs font-medium border border-border hover:bg-accent transition-colors"
                            onclick="toggleCode('code-{{ loop.index0 }}-{{ loop.parent.loop.index0 }}')">
                        View Code
                    </button>
                </td>
            </tr>
            <tr id="code-{{ loop.index0 }}-{{ loop.parent.loop.index0 }}" class="hidden">
                <td colspan="4" class="py-2 px-3">
                    <pre class="bg-background p-4 rounded-lg overflow-x-auto text-sm font-mono text-muted-foreground"><code>{{ suite.code }}</code></pre>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}
{% else %}
<div class="bg-card border border-border rounded-lg p-8 text-center">
    <p class="text-sm text-muted-foreground">No test suites generated yet. Run the pipeline to generate tests.</p>
</div>
{% endif %}

<!-- Inline rules editor -->
<div class="bg-card border border-border rounded-lg p-5 mt-8">
    <h3 class="text-lg font-semibold mb-3">Rules (Quick Edit)</h3>
    <form hx-put="/api/projects/{{ project.id }}/rules" hx-swap="none"
          hx-on::after-request="if(event.detail.successful){showToast('Rules saved successfully','success')}else{showToast('Failed to save rules')}">
        <textarea name="rules_yaml" rows="10"
                  class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground text-sm font-mono placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
        >{{ rules_yaml }}</textarea>
        <div class="flex items-center gap-3 mt-3">
            <button type="submit"
                    class="inline-flex items-center px-4 py-2 rounded-lg bg-primary text-primary-foreground text-sm font-medium hover:bg-primary-hover transition-colors">
                Save Rules
            </button>
            <button type="button" id="validate-btn"
                    class="inline-flex items-center px-4 py-2 rounded-lg bg-secondary text-secondary-foreground text-sm font-medium border border-border hover:bg-accent transition-colors">
                Validate
            </button>
        </div>
    </form>
</div>
{% endblock %}
{% block scripts %}
<script>
function toggleCode(id) {
    const row = document.getElementById(id);
    row.classList.toggle('hidden');
}
document.getElementById('validate-btn')?.addEventListener('click', function() {
    var yaml = document.querySelector('[name=rules_yaml]').value;
    fetch('/api/rules/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({yaml: yaml})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.valid) {
            showToast('Valid YAML configuration', 'success');
        } else {
            showToast('Invalid: ' + data.error, 'error');
        }
    })
    .catch(function() {
        showToast('Validation request failed', 'error');
    });
});
</script>
{% endblock %}
