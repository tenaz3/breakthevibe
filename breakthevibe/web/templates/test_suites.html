{% extends "base.html" %}
{% block title %}Test Suites â€” {{ project.name }}{% endblock %}
{% block content %}
<a href="/projects/{{ project.id }}" class="back-link">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    {{ project.name }}
</a>

<div class="page-header mb-6">
    <h1>Test Suites</h1>
</div>

<!-- Category filter -->
<div class="flex gap-2 flex-wrap mb-6">
    <a href="?category="
       class="btn btn-sm {% if not category %}btn-primary{% else %}btn-secondary{% endif %}">
        All
    </a>
    <a href="?category=functional"
       class="btn btn-sm {% if category == 'functional' %}btn-primary{% else %}btn-secondary{% endif %}">
        Functional
    </a>
    <a href="?category=visual"
       class="btn btn-sm {% if category == 'visual' %}btn-primary{% else %}btn-secondary{% endif %}">
        Visual
    </a>
    <a href="?category=api"
       class="btn btn-sm {% if category == 'api' %}btn-primary{% else %}btn-secondary{% endif %}">
        API
    </a>
</div>

{% if suites_by_route %}
<div class="space-y-4 stagger-children">
{% for route, suites in suites_by_route.items() %}
    <div class="card">
        <div class="card-header">
            <h3 class="text-[0.9375rem] font-semibold">{{ route }}</h3>
        </div>
        <div class="px-6 pb-4 pt-3">
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Suite</th>
                            <th>Category</th>
                            <th>Steps</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for suite in suites %}
                        <tr>
                            <td class="text-foreground">{{ suite.name }}</td>
                            <td>
                                <span class="badge
                                    {% if suite.category == 'functional' %}badge-info
                                    {% elif suite.category == 'visual' %}badge-warning
                                    {% elif suite.category == 'api' %}badge-success
                                    {% else %}badge-secondary{% endif %}">
                                    {{ suite.category }}
                                </span>
                            </td>
                            <td class="text-muted-foreground">{{ suite.step_count }}</td>
                            <td class="text-right">
                                <button class="btn btn-ghost btn-sm"
                                        onclick="toggleCode('code-{{ loop.index0 }}-{{ loop.parent.loop.index0 }}')">
                                    View Code
                                </button>
                            </td>
                        </tr>
                        <tr id="code-{{ loop.index0 }}-{{ loop.parent.loop.index0 }}" class="hidden">
                            <td colspan="4" class="!p-0">
                                <pre class="code-block m-3"><code>{{ suite.code }}</code></pre>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endfor %}
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        <p>No test suites generated yet</p>
        <p>Run the pipeline to generate tests.</p>
    </div>
</div>
{% endif %}

<!-- Inline rules editor -->
<hr class="separator">

<div class="card">
    <div class="card-header">
        <h3>Quick Rules Editor</h3>
    </div>
    <div class="card-content">
        <form hx-put="/api/projects/{{ project.id }}/rules" hx-swap="none"
              hx-on::after-request="if(event.detail.successful){showToast('Rules saved','success')}else{showToast('Failed to save rules')}">
            <textarea name="rules_yaml" rows="8" class="code-editor" style="min-height:200px">{{ rules_yaml }}</textarea>
            <div class="flex items-center gap-3 mt-3">
                <button type="submit" class="btn btn-primary">Save Rules</button>
                <button type="button" id="validate-btn" class="btn btn-secondary">Validate</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleCode(id) {
    var row = document.getElementById(id);
    row.classList.toggle('hidden');
}

document.getElementById('validate-btn')?.addEventListener('click', function() {
    var yaml = document.querySelector('[name=rules_yaml]').value;
    fetch('/api/rules/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({yaml: yaml})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.valid) {
            showToast('Valid YAML configuration', 'success');
        } else {
            showToast('Invalid: ' + data.error, 'error');
        }
    })
    .catch(function() {
        showToast('Validation request failed', 'error');
    });
});
</script>
{% endblock %}
